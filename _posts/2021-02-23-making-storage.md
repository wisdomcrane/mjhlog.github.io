---
title: "redux-persist 걷어내기"
date: 2021-02-22 00:00:00
categories: journal
---

앱을 사용하다보니 노트를 전환할 때 입력한 데이터가 사라지는 문제가 있었다.

redux-persist를 사용하고 있었는데 로컬스토리지에는 최신본이 저장이 되지만 state에는 최신이 반영되지 않아 발생하는 문제였다. 그래서 로컬 스토리지에 있는 데이터를 가져와서 통째로 스토어를 교체하는 방식을 쓰고 있었다.

async-storage를 다루는게 생각해보면 복잡하지 않은 일인데 어렵게 다루는 것 같았다. 리덕스 퍼시스트는 깃허브를 보니 커밋이 몇년이 된게 많았고 이슈도 생각보다 많았다. 나중에 업데이트하고 그러면 로직을 파악하고 있지 않으면 골치가 아플 것 같아서 바꾸기로 했다.

일단 store.subscribe에서 각 노트는 키 값에 따라 따로 저장하고 스테이트는 하나의 키에 저장하기로 했다. 불러올 때도 App.js에서 스테이트를 먼저 불러와서 세팅해주고 백업된 노트는 호출이 있을 때 마다 키 값에 따라 로드하기로 했다.

하지만 문제는 async storage는 병합이 쉽지 않다는 것이다. 데이터를 저장할 때 이전 값이랑 merge를 해줘야 하는데 여기서 이전값을 불러올 때 Async 기능을 사용하면 병목 현상이 생긴다. mergeItem 기능이 있기는 하지만 모든 네이티브에서 완벽하게 지원되지 않는것 같다. (이건 확인해보지는 못했다.) 그래서 일단 각 노트마다 새로운 키를 @note:key의 형태로 만들어 사용해보고 있다. 노트가 많이 늘어날 때는 분명 한계점이 생길 것이다. 거기에다 안드로이드에는 AsyncStorage의 저장 한계가 6MB 정도라고 하니 근본적인 해결책은 되지 않을 것 같다.

결국에는 realm을 사용할 것 같다. 나중에 몽고디비 서버를 이용하기도 편하니 괜찮은 선택일 것 같다.

휴 로컬 저장이 생각보다 복잡하다. 그래도 데이터 문제는 지금 고민해 두지 않으면 나중에 바꾸기기 힘드니 시간을 투자해야겠다.
